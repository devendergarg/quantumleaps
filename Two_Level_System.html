<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Level System Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --primary-color: #e94560;
            --secondary-color: #0f3460;
            --text-color: #f0f0f0;
            --text-muted: #aaa;
            --grid-color: rgba(255, 255, 255, 0.1);
            --highlight-bg: rgba(233, 69, 96, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden; 
        }

        .main-container {
            width: 100%;
            max-width: 900px;
            background-color: var(--secondary-color);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 1.5rem 2rem;
        }
        
        h1 { 
            color: var(--primary-color);
            text-align: center;
            margin: 0 0 1rem 0;
        }

        .explanation { 
            color: var(--text-muted); 
            line-height: 1.6; 
            margin: 0 auto 1.5rem auto; 
            max-width: 700px; 
            text-align: center; 
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--grid-color);
        }

        .slider-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; 
        }

        .slider-group label {
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0; 
        }
        
        .slider-control {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1; 
            min-width: 200px; 
        }

        input[type="range"] {
            flex-grow: 1;
            -webkit-appearance: none;
            height: 8px;
            background: #16213e;
            border-radius: 5px;
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
            cursor: pointer;
        }

        input[type="range"]:hover { opacity: 1; }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        #particle-count-display {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary-color);
            min-width: 30px;
            text-align: center;
        }

        .toggle-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; 
        }
        
        .control-label {
            font-weight: 500;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .tabs { display: flex; gap: 10px; }
        
        #temp-tabs {
            flex-grow: 1;
            justify-content: space-between;
            gap: 5px; 
        }

        .tab-card, .view-toggle {
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            background-color: transparent;
            color: var(--primary-color);
            text-align: center;
            flex-shrink: 0;
        }

        .tab-card:hover, .view-toggle:hover {
            background-color: var(--highlight-bg);
        }

        .tab-card.active, .view-toggle.active {
            background-color: var(--primary-color);
            color: white;
        }

        .results-container canvas {
            width: 100%;
            height: auto;
            display: block;
            border: 2px solid var(--grid-color);
            background-color: #16213e;
            border-radius: 8px;
        }
        
        #table-container {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid var(--grid-color);
            padding: 10px 12px;
            text-align: center;
        }
        
        th {
            background-color: #16213e;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: rgba(22, 33, 62, 0.5);
        }
        
        tr.peak-probability td {
            font-weight: bold;
            background-color: var(--highlight-bg);
            color: var(--primary-color);
        }

        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--text-muted);
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            body { 
                padding: 10px;
            }
            .main-container {
                padding: 1.5rem 1rem;
                border-radius: 8px;
            }
            .toggle-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            .control-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<div class="main-container">
    <h1>Two-Level System Simulator</h1>
    <p class="explanation">
        Explore how particles distribute themselves between two energy levels. See how the energy cost to excite a particle (&Delta;E) competes with the available thermal energy (k<sub>B</sub>T) to determine the most probable state.
    </p>

    <div class="controls-container">
        <div class="slider-group">
            <label for="particles-slider">Number of Particles (N):</label>
            <div class="slider-control">
                <input type="range" id="particles-slider" value="50" min="2" max="100">
                <span id="particle-count-display">50</span>
            </div>
        </div>
        <div class="toggle-controls">
            <div class="control-group">
                <span class="control-label">Temperature:</span>
                <div class="tabs" id="temp-tabs">
                    <div class="tab-card" data-temp="low">Low</div>
                    <div class="tab-card active" data-temp="resonance">Resonance</div>
                    <div class="tab-card" data-temp="high">High</div>
                    <div class="tab-card" data-temp="superhigh">Super-High</div>
                </div>
            </div>
            <div class="control-group">
                <span class="control-label">View Mode:</span>
                <div class="tabs" id="view-toggles">
                    <div class="view-toggle" data-view="factors">Factors</div>
                    <div class="view-toggle active" data-view="probability">Probability</div>
                </div>
            </div>
        </div>
    </div>

    <div class="results-container">
        <canvas id="distributionChart"></canvas>
        <div id="table-container"></div>
    </div>

</div>

<footer>
    <p>Created by Dr. Devender Garg</p>
</footer>

<script>
    const particleSlider = document.getElementById('particles-slider');
    const particleCountDisplay = document.getElementById('particle-count-display');
    const tempTabsContainer = document.getElementById('temp-tabs');
    const viewTogglesContainer = document.getElementById('view-toggles');
    const tableContainer = document.getElementById('table-container');
    const chartCanvas = document.getElementById('distributionChart').getContext('2d');

    let state = {
        numParticles: 50,
        tempName: 'resonance',
        view: 'probability'
    };
    
    const temperatures = {
        low: 0.1, 
        resonance: 1.0, 
        high: 10.0, 
        superhigh: 100.0
    };
    const colors = {
        textColor: getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
        gridColor: getComputedStyle(document.documentElement).getPropertyValue('--grid-color'),
        primaryColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color')
    };

    let chartInstance = null;

    function drawSubscriptAnnotation(ctx, parts, x, y) {
        const [normal1, sub, normal2] = parts;
        const normalFont = '14px "Segoe UI", Arial, sans-serif';
        const subFont = '10px "Segoe UI", Arial, sans-serif';

        ctx.save();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-muted');
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom'; 

        ctx.font = normalFont;
        const w2 = ctx.measureText(normal2).width;
        ctx.font = subFont;
        const wSub = ctx.measureText(sub).width;
        
        let currentX = x;
        
        ctx.font = normalFont;
        ctx.fillText(normal2, currentX, y);
        currentX -= w2;

        ctx.font = subFont;
        ctx.fillText(sub, currentX, y + 2);
        currentX -= wSub;
        
        ctx.font = normalFont;
        ctx.fillText(normal1, currentX, y);

        ctx.restore();
    }

    const annotationPlugin = {
        id: 'customAnnotation',
        afterDraw(chart) {
            if (state.view !== 'probability') return;

            const annotationTextMap = {
                low:       ['k', 'B', ' T = 0.1 \u0394E'],
                resonance: ['k', 'B', ' T = \u0394E'],
                high:      ['k', 'B', ' T = 10 \u0394E'],
                superhigh: ['k', 'B', ' T = 100 \u0394E']
            };

            const textParts = annotationTextMap[state.tempName];
            if (!textParts) return;

            const { ctx, chartArea: { top, right } } = chart;
            drawSubscriptAnnotation(ctx, textParts, right - 10, top + 20);
        }
    };
    Chart.register(annotationPlugin);

    const g = 7;
    const p = [0.99999999999980993, 676.5203681218851, -1259.1392167224028, 771.32342877765313, -176.61502916214059, 12.507343278686905, -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
    function logGamma(z) {
        if (z < 0.5) return Math.PI / (Math.sin(Math.PI * z) * Math.exp(logGamma(1 - z)));
        z -= 1;
        let x = p[0];
        for (let i = 1; i < g + 2; i++) {
            x += p[i] / (z + i);
        }
        const t = z + g + 0.5;
        return 0.5 * Math.log(2 * Math.PI) + (z + 0.5) * Math.log(t) - t + Math.log(x);
    }

    function logCombinations(n, k) {
        if (k < 0 || k > n) return -Infinity;
        return logGamma(n + 1) - logGamma(k + 1) - logGamma(n - k + 1);
    }

    function calculateData() {
        const N = state.numParticles;
        const kT = temperatures[state.tempName];
        let results = [];
        let logFactors = [];

        for (let n1 = 0; n1 <= N; n1++) {
            const logSystemGain = logCombinations(N, n1);
            const energy = n1;
            const logReservoirCost = -energy / kT;
            const logTotalFactor = logSystemGain + logReservoirCost;
            
            results.push({ n1, n0: N - n1, logTotalFactor });
            logFactors.push(logTotalFactor);
        }
        
        if (logFactors.length === 0) return [];
        const maxLog = Math.max(...logFactors);
        if (maxLog === -Infinity) return results.map(r => ({ ...r, probability: 0, totalFactor: 0 }));

        let sumOfExponentials = 0;
        for (const logFactor of logFactors) {
            sumOfExponentials += Math.exp(logFactor - maxLog);
        }
        const logZ = maxLog + Math.log(sumOfExponentials);

        results.forEach(res => {
            const logProbability = res.logTotalFactor - logZ;
            res.probability = Math.exp(logProbability) * 100;
            res.totalFactor = Math.exp(res.logTotalFactor);
            res.systemGain = Math.exp(logCombinations(N, res.n1));
            res.reservoirCost = Math.exp(-res.n1 / kT);
        });

        return results;
    }
    
    function render() {
        const data = calculateData();
        document.querySelectorAll('.tab-card').forEach(tab => tab.classList.toggle('active', tab.dataset.temp === state.tempName));
        document.querySelectorAll('.view-toggle').forEach(toggle => toggle.classList.toggle('active', toggle.dataset.view === state.view));
        renderTable(data);
        renderChart(data);
    }
    
    function formatNumber(num) {
        if (num === 0) return '0';
        if (isFinite(num) && num > 0.001 && num < 1000000) {
            return Number(num.toPrecision(3)).toString();
        } else if (!isFinite(num)) {
            return "Infinity";
        } else {
            const exponent = Math.floor(Math.log10(Math.abs(num)));
            const mantissa = num / Math.pow(10, exponent);
            return `${mantissa.toFixed(2)} &times; 10<sup>${exponent}</sup>`;
        }
    }

    function renderTable(data) {
        let tableHTML = '<table><thead><tr>';
        if (state.view === 'factors') {
            tableHTML += `<th>Excited (N₁)</th><th>System Gain (Ω_sys)</th><th>Reservoir Cost</th><th>Total Factor</th>`;
        } else {
            tableHTML += `<th>Distribution (G, E)</th><th>Probability (%)</th>`;
        }
        tableHTML += '</tr></thead><tbody>';

        let peakValue, peakIndex;
        const key = state.view === 'probability' ? 'probability' : 'totalFactor';
        peakValue = Math.max(...data.map(d => d[key]));
        peakIndex = data.findIndex(d => d[key] === peakValue);

        data.forEach((row, index) => {
            const isPeak = index === peakIndex;
            tableHTML += `<tr class="${isPeak ? 'peak-probability' : ''}">`;
            if (state.view === 'factors') {
                tableHTML += `<td>${row.n1}</td><td>${formatNumber(row.systemGain)}</td><td>${formatNumber(row.reservoirCost)}</td><td>${formatNumber(row.totalFactor)}</td>`;
            } else {
                tableHTML += `<td>(${row.n0}, ${row.n1})</td><td>${row.probability.toFixed(2)}%</td>`;
            }
            tableHTML += '</tr>';
        });
        tableHTML += '</tbody></table>';
        tableContainer.innerHTML = tableHTML;
    }
    
    function renderChart(data) {
        if (chartInstance) chartInstance.destroy();
        const labels = data.map(row => `${row.n1}`);
        const chartData = data.map(row => row[state.view === 'factors' ? 'totalFactor' : 'probability']);
        const yAxisLabel = state.view === 'factors' ? 'Total Microstate Factor (log scale)' : 'Probability (%)';

        const chartOptions = {
            responsive: true,
            aspectRatio: 1.5, 
            plugins: {
                legend: { display: false },
                title: { display: false } 
            },
            scales: {
                y: {
                    type: state.view === 'factors' ? 'logarithmic' : 'linear',
                    beginAtZero: true,
                    grid: { color: colors.gridColor },
                    ticks: { color: colors.textColor },
                    title: { display: true, text: yAxisLabel, color: colors.textColor }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: colors.textColor },
                    title: { display: true, text: 'Number of Excited Particles (N₁)', color: colors.textColor }
                }
            }
        };

        if (state.view === 'factors') {
            const superscripts = {'0':'⁰', '1':'¹', '2':'²', '3':'³', '4':'⁴', '5':'⁵', '6':'⁶', '7':'⁷', '8':'⁸', '9':'⁹', '-': '⁻'};
            chartOptions.scales.y.ticks.callback = function(value) {
                if (Math.abs(Math.log10(value) % 1) < 1e-9 && value > 0) {
                    const exponent = Math.log10(value).toFixed(0);
                    const exponentChars = exponent.toString().split('').map(char => superscripts[char] || '').join('');
                    return '10' + exponentChars;
                }
                return '';
            };
        }

        chartInstance = new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: yAxisLabel,
                    data: chartData,
                    backgroundColor: 'rgba(233, 69, 96, 0.7)',
                    borderColor: colors.primaryColor,
                    borderWidth: 1
                }]
            },
            options: chartOptions
        });
    }

    particleSlider.addEventListener('input', () => {
        const num = parseInt(particleSlider.value, 10);
        state.numParticles = num;
        particleCountDisplay.textContent = num;
        render();
    });

    tempTabsContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-card')) {
            state.tempName = e.target.dataset.temp;
            render();
        }
    });

    viewTogglesContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-toggle')) { 
            state.view = e.target.dataset.view;
            render();
        }
    });

    render();
</script>

</body>
</html>