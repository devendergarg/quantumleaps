<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Pro: Final Analytics Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .heatmap-cell { transition: all 0.2s; cursor: pointer; }
        .heatmap-cell:hover { transform: scale(1.05); border: 2px solid #333; z-index: 10; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        th { font-size: 0.7rem; text-transform: uppercase; color: #64748b; letter-spacing: 0.025em; padding: 0.5rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="card bg-slate-900 text-white border-none">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold">üìà Shorts Growth Pro</h1>
                    <p class="text-slate-400 mt-1">Full 2025 Analytics: Hook, Pacing, and Tag-Level Performance with STD.</p>
                </div>
                <div class="w-full md:w-auto">
                    <label class="block mb-2 text-sm font-medium text-slate-300">Upload YouTube CSV</label>
                    <input type="file" id="csvInput" accept=".csv" class="block w-full text-sm text-slate-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none p-2">
                </div>
            </div>
        </div>

        <div id="dashboard" class="hidden space-y-8">

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="card text-center border-l-4 border-slate-400">
                    <p class="text-xs text-gray-500 uppercase font-bold">Total Views</p>
                    <p class="text-2xl font-bold text-slate-700" id="statViews">0</p>
                </div>
                <div class="card text-center border-l-4 border-green-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Engaged Views</p>
                    <p class="text-2xl font-bold text-green-600" id="statEngaged">0</p>
                </div>
                <div class="card text-center border-l-4 border-purple-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Avg Stayed %</p>
                    <p class="text-2xl font-bold text-purple-600" id="statStayed">0%</p>
                </div>
                <div class="card text-center border-l-4 border-orange-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Avg Retention</p>
                    <p class="text-2xl font-bold text-orange-600" id="statRetention">0%</p>
                </div>
            </div>

            <!-- TREND CHART -->
            <div class="card">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Hook Trend (Stayed to Watch %)</h2>
                <div class="h-64 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- TAG ANALYSIS GRID -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Top Keywords -->
                <div class="card border-l-4 border-blue-500">
                    <h2 class="text-lg font-bold text-blue-700 mb-4">üîë Top Keywords</h2>
                    <table class="min-w-full text-xs text-left">
                        <thead><tr class="border-b"><th>Keyword</th><th class="text-right">Avg Stayed ¬± STD</th><th class="text-right">Uses</th></tr></thead>
                        <tbody id="keywordTable"></tbody>
                    </table>
                </div>
                <!-- Top Hashtags -->
                <div class="card border-l-4 border-green-500">
                    <h2 class="text-lg font-bold text-green-700 mb-4">‚úÖ Best Hashtags</h2>
                    <table class="min-w-full text-xs text-left">
                        <thead><tr class="border-b"><th>Hashtag</th><th class="text-right">Avg Stayed ¬± STD</th><th class="text-right">Uses</th></tr></thead>
                        <tbody id="hashtagBestTable"></tbody>
                    </table>
                </div>
                <!-- Worst Hashtags -->
                <div class="card border-l-4 border-red-500">
                    <h2 class="text-lg font-bold text-red-700 mb-4">‚ùå Worst Hashtags</h2>
                    <table class="min-w-full text-xs text-left">
                        <thead><tr class="border-b"><th>Hashtag</th><th class="text-right">Avg Stayed ¬± STD</th><th class="text-right">Uses</th></tr></thead>
                        <tbody id="hashtagWorstTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- PERFORMANCE AUTOPSY -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card border-t-4 border-green-500">
                    <h2 class="font-bold text-green-700 mb-4 text-center">üíé Elite Hooks</h2>
                    <table class="min-w-full text-[10px] text-left">
                        <thead><tr class="border-b"><th>Video Title</th><th class="text-right">Stayed%</th></tr></thead>
                        <tbody id="topHookTable"></tbody>
                    </table>
                </div>
                <div class="card border-t-4 border-red-500">
                    <h2 class="font-bold text-red-700 mb-4 text-center">üõë Worst Hooks</h2>
                    <table class="min-w-full text-[10px] text-left">
                        <thead><tr class="border-b"><th>Video Title</th><th class="text-right">Stayed%</th></tr></thead>
                        <tbody id="worstHookTable"></tbody>
                    </table>
                </div>
                <div class="card border-t-4 border-yellow-500">
                    <h2 class="font-bold text-yellow-700 mb-4 text-center">üìâ Pacing Fails</h2>
                    <table class="min-w-full text-[10px] text-left">
                        <thead><tr class="border-b"><th>Video Title</th><th class="text-right">Pacing</th></tr></thead>
                        <tbody id="worstPacingTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Correlation -->
            <div class="card overflow-hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üî• Relationship Matrix</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-center border-collapse">
                        <thead id="matrixHead"></thead>
                        <tbody id="matrixBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Main Data Table -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Video Detail Table</h2>
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th>Date</th>
                                <th>Video Title</th>
                                <th class="text-right">Views</th>
                                <th class="text-right">Stayed%</th>
                                <th class="text-right">Pacing Logic</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let globalData = [];
        let trendChartInstance = null;

        const metricsList = [
            { id: 'duration', label: 'Duration' },
            { id: 'views', label: 'Views' },
            { id: 'engagedViews', label: 'Engaged' },
            { id: 'stayedToWatch', label: 'Stayed%' },
            { id: 'percentageViewed', label: 'Retention%' },
            { id: 'subscribers', label: 'Subs' },
            { id: 'impressions', label: 'Impr.' },
            { id: 'ctr', label: 'CTR%' }
        ];

        document.getElementById('csvInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                processCSV(event.target.result);
                document.getElementById('dashboard').classList.remove('hidden');
            };
            reader.readAsText(file);
        });

        function parseCSVLine(text) {
            const result = [];
            let cell = '', inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(cell); cell = ''; }
                else cell += char;
            }
            result.push(cell);
            return result;
        }

        function cleanNumber(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/%/g, '').replace(/,/g, '')) || 0;
        }

        // --- NEW: Standard Deviation Helper ---
        function calculateStdDev(array) {
            if (array.length < 2) return 0;
            const n = array.length;
            const mean = array.reduce((a, b) => a + b) / n;
            const variance = array.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
            return Math.sqrt(variance);
        }

        function processCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(l => l.trim().length > 0);
            const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase());
            const findIdx = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));

            const idx = {
                title: headers.findIndex(h => h.includes('title') && !h.includes('content')),
                date: findIdx(['publish time', 'date']),
                duration: findIdx(['duration']),
                views: headers.indexOf('views') === -1 ? findIdx(['views']) : headers.indexOf('views'),
                engaged: findIdx(['engaged views']),
                stayed: findIdx(['stayed to watch']),
                avgPct: findIdx(['average percentage viewed', 'avg %']),
                subs: findIdx(['subscribers']),
                impressions: findIdx(['impressions']),
                ctr: findIdx(['click-through rate', 'ctr'])
            };

            const parsedData = [];
            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVLine(lines[i]);
                if (row.length < 5 || row[idx.title] === "Total") continue;

                const views = cleanNumber(row[idx.views]);
                const duration = cleanNumber(row[idx.duration]);
                
                if (duration > 0 && duration <= 61 && views >= 10) {
                    const stayed = cleanNumber(row[idx.stayed]);
                    const retention = cleanNumber(row[idx.avgPct]);
                    parsedData.push({
                        title: row[idx.title].replace(/^"|"$/g, ''),
                        date: new Date(row[idx.date] ? row[idx.date].replace(/^"|"$/g, '') : ""),
                        dateStr: row[idx.date] ? row[idx.date].replace(/^"|"$/g, '') : "N/A",
                        duration, views, engagedViews: cleanNumber(row[idx.engaged]),
                        stayedToWatch: stayed, percentageViewed: retention,
                        pacingScore: stayed - retention, subscribers: cleanNumber(row[idx.subs]),
                        impressions: cleanNumber(row[idx.impressions]), ctr: cleanNumber(row[idx.ctr])
                    });
                }
            }
            globalData = parsedData.sort((a,b) => a.date - b.date);
            updateDashboard();
        }

        // --- MODIFIED: Text analysis to include STD ---
        function analyzeText(data) {
            const words = {}, tags = {};
            data.forEach(d => {
                const titleParts = d.title.toLowerCase().split(/\s+/);
                const uniqueParts = [...new Set(titleParts)];

                uniqueParts.forEach(part => {
                    let clean = part.replace(/[.,\/!$%\^&\*;:{}=\-_`~()]/g, "");
                    if (clean.length < 2) return;

                    if (part.startsWith('#')) {
                        if (!tags[part]) tags[part] = { values: [] };
                        tags[part].values.push(d.stayedToWatch);
                    } else {
                        if (!words[clean]) words[clean] = { values: [] };
                        words[clean].values.push(d.stayedToWatch);
                    }
                });
            });

            const mapper = (map) => Object.keys(map)
                .map(k => {
                    const values = map[k].values;
                    const count = values.length;
                    const avg = values.reduce((a, b) => a + b, 0) / count;
                    const stdDev = calculateStdDev(values); // Calculate STD
                    return { label: k, avg, stdDev, count }; // Return object with stdDev
                })
                .filter(i => i.count >= 2);

            const keywords = mapper(words).sort((a,b) => b.avg - a.avg).slice(0, 10);
            const sortedHashtags = mapper(tags).sort((a,b) => b.avg - a.avg);
            
            return { 
                keywords, 
                bestTags: sortedHashtags.slice(0, 10), 
                worstTags: [...sortedHashtags].reverse().slice(0, 10) 
            };
        }

        function updateDashboard() {
            // Stats
            document.getElementById('statViews').innerText = Math.round(globalData.reduce((a,b)=>a+b.views,0)).toLocaleString();
            document.getElementById('statEngaged').innerText = Math.round(globalData.reduce((a,b)=>a+b.engagedViews,0)).toLocaleString();
            document.getElementById('statStayed').innerText = (globalData.reduce((a,b)=>a+b.stayedToWatch,0)/globalData.length).toFixed(1) + '%';
            document.getElementById('statRetention').innerText = (globalData.reduce((a,b)=>a+b.percentageViewed,0)/globalData.length).toFixed(1) + '%';

            // --- MODIFIED: Render STD in tag tables ---
            const { keywords, bestTags, worstTags } = analyzeText(globalData);
            const renderTagTable = (id, list, colorClass) => {
                document.getElementById(id).innerHTML = list.map(i => `
                    <tr class="border-b">
                        <td class="py-2 font-medium text-slate-700">${i.label}</td>
                        <td class="text-right font-bold ${colorClass}">${i.avg.toFixed(1)}% <span class="text-slate-400 font-normal">¬±${i.stdDev.toFixed(1)}</span></td>
                        <td class="text-right text-slate-400">${i.count}</td>
                    </tr>
                `).join('');
            };
            renderTagTable('keywordTable', keywords, 'text-blue-600');
            renderTagTable('hashtagBestTable', bestTags, 'text-green-600');
            renderTagTable('hashtagWorstTable', worstTags, 'text-red-600');

            // Autopsy Lists (Converted to Tables)
            const sortedHooks = [...globalData].sort((a,b) => b.stayedToWatch - a.stayedToWatch);
            
            document.getElementById('topHookTable').innerHTML = sortedHooks.slice(0, 10).map(v => `
                <tr class="border-b hover:bg-green-50"><td class="py-1 pr-2 truncate max-w-[120px]">${v.title}</td><td class="text-right font-bold text-green-600">${v.stayedToWatch}%</td></tr>
            `).join('');

            document.getElementById('worstHookTable').innerHTML = [...sortedHooks].reverse().slice(0, 10).map(v => `
                <tr class="border-b hover:bg-red-50"><td class="py-1 pr-2 truncate max-w-[120px]">${v.title}</td><td class="text-right font-bold text-red-600">${v.stayedToWatch}%</td></tr>
            `).join('');

            const sortedPacing = [...globalData].sort((a,b) => b.pacingScore - a.pacingScore);
            document.getElementById('worstPacingTable').innerHTML = sortedPacing.slice(0, 10).map(v => `
                <tr class="border-b hover:bg-yellow-50"><td class="py-1 pr-2 truncate max-w-[120px]">${v.title}</td><td class="text-right font-bold text-yellow-700">${v.pacingScore > 0 ? '-' : '+'}${Math.abs(v.pacingScore).toFixed(1)}</td></tr>
            `).join('');

            updateTrendChart();
            buildMatrix();

            // Detailed Data Table
            document.getElementById('dataTableBody').innerHTML = [...globalData].sort((a,b) => b.date - a.date).map(d => `
                <tr class="border-b text-xs hover:bg-gray-50">
                    <td class="p-2 whitespace-nowrap text-gray-400">${d.dateStr}</td>
                    <td class="p-2 truncate max-w-xs font-medium">${d.title}</td>
                    <td class="p-2 text-right">${d.views.toLocaleString()}</td>
                    <td class="p-2 text-right font-bold text-purple-600">${d.stayedToWatch}%</td>
                    <td class="p-2 text-right ${d.pacingScore > 0 ? 'text-red-500' : 'text-green-500'}">${d.pacingScore > 0 ? 'Drop: -' : 'Loop: +'}${Math.abs(d.pacingScore).toFixed(1)}</td>
                </tr>
            `).join('');
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const sorted = [...globalData].filter(d => d.date != null);
            const raw = sorted.map(d => d.stayedToWatch);
            const mAvg = raw.map((v, i, a) => i < 2 ? null : (a[i] + a[i-1] + a[i-2]) / 3);
            if (trendChartInstance) trendChartInstance.destroy();
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(d => d.date),
                    datasets: [
                        { label: 'Stayed%', data: raw, borderColor: '#cbd5e1', borderWidth: 1, pointRadius: 1, fill: false },
                        { label: '3-Video Avg', data: mAvg, borderColor: '#3b82f6', borderWidth: 3, pointRadius: 0, tension: 0.3, fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time' }, y: { min: 0, max: 100 } } }
            });
        }

        function calculateCorrelation(xKey, yKey) {
            const x = globalData.map(d => d[xKey]), y = globalData.map(d => d[yKey]), n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0), sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((s, v, i) => s + v * y[i], 0), sumX2 = x.reduce((s, v) => s + v * v, 0), sumY2 = y.reduce((s, v) => s + v * v, 0);
            const num = (n * sumXY) - (sumX * sumY);
            const den = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));
            return den === 0 ? 0 : num / den;
        }

        function buildMatrix() {
            const head = document.getElementById('matrixHead'), body = document.getElementById('matrixBody');
            head.innerHTML = '<tr><th class="p-2">Metric</th>' + metricsList.map(m => `<th class="p-2">${m.label}</th>`).join('') + '</tr>';
            body.innerHTML = metricsList.map(rowM => `
                <tr>
                    <td class="p-2 bg-gray-50 text-left font-bold text-[10px]">${rowM.label}</td>
                    ${metricsList.map(colM => {
                        if (rowM.id === colM.id) return '<td class="p-2 text-gray-200">-</td>';
                        const corr = calculateCorrelation(rowM.id, colM.id);
                        const color = corr > 0 ? `rgba(34, 197, 94, ${Math.abs(corr)})` : `rgba(239, 68, 68, ${Math.abs(corr)})`;
                        return `<td class="p-2 font-mono font-bold text-[10px]" style="background-color: ${color}">${corr.toFixed(2)}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
