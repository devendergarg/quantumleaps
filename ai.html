<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gradio Audio Merger Client</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 700px; margin: 40px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        h1, h2 { text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="file"], input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { display: block; width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 15px; border-radius: 5px; background-color: #f0f0f0; text-align: center; font-weight: 500; white-space: pre-wrap; word-wrap: break-word; }
        #video-container { margin-top: 20px; }
        video { width: 100%; border-radius: 5px; background-color: #000; }
    </style>
</head>
<body>

    <h1>Merge Audio with Video</h1>
    <h2>(Using @gradio/client)</h2>

    <div class="form-group">
        <label for="apiUrl">Your Hugging Face Space URL:</label>
        <input type="text" id="spaceUrl" value="https://devendergarg14-animatemyidea1.hf.space/">
        <small>This should be the base URL of your Gradio Space.</small>
    </div>

    <div class="form-group">
        <label for="videoFile">1. Select Video File (.mp4):</label>
        <input type="file" id="videoFile" accept="video/mp4">
    </div>

    <div class="form-group">
        <label for="audioFile">2. Select Audio File (.wav, .mp3, etc.):</label>
        <input type="file" id="audioFile" accept="audio/*">
    </div>

    <button id="mergeButton">Merge Files</button>

    <div id="status">Status: Waiting for files...</div>

    <div id="video-container" style="display: none;">
        <h2>Result</h2>
        <video id="videoResult" controls></video>
    </div>

    <!-- SCRIPT 1: The "Sentry" Script -->
    <!-- This script checks if the main module script fails to load. -->
    <script>
        // Create a global flag. The module script will set this to true if it loads.
        window.gradioClientLoaded = false;

        // After 2 seconds, check the flag.
        setTimeout(() => {
            if (!window.gradioClientLoaded) {
                const statusDiv = document.getElementById('status');
                // If the flag is still false, it means the module was blocked by the browser.
                statusDiv.innerHTML = `
                    <strong style="color: red;">Initialization Error: Failed to load Gradio Client library.</strong>
                    <br><br>
                    This is expected when you open an HTML file directly.
                    <br><br>
                    <strong>To fix this, please run the file using a local web server.</strong>
                    <br>
                    (For example, with the "Live Server" extension in VS Code, or by running 'python -m http.server' in this folder).
                `;
                document.getElementById('mergeButton').disabled = true;
            }
        }, 2000); // 2-second delay
    </script>

    <!-- SCRIPT 2: The Main Application Logic -->
    <!-- This is a module, so it will be blocked when run from file:/// -->
    <script type="module">
        // If this line runs, it means the import was successful.
        // We update the flag to prevent the sentry script from showing an error.
        window.gradioClientLoaded = true;

        import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client@0.14.0/dist/index.min.js";

        const videoFileInput = document.getElementById('videoFile');
        const audioFileInput = document.getElementById('audioFile');
        const mergeButton = document.getElementById('mergeButton');
        const statusDiv = document.getElementById('status');
        const spaceUrlInput = document.getElementById('spaceUrl');
        const videoContainer = document.getElementById('video-container');
        const videoResult = document.getElementById('videoResult');

        mergeButton.addEventListener('click', async () => {
            console.log("Merge button clicked.");
            statusDiv.textContent = 'Process started...'; 
            
            const videoFile = videoFileInput.files[0];
            const audioFile = audioFileInput.files[0];
            const spaceUrl = spaceUrlInput.value.trim();

            if (!videoFile || !audioFile) {
                statusDiv.textContent = 'Error: Please select both a video and an audio file.';
                return;
            }
            if (!spaceUrl) {
                statusDiv.textContent = 'Error: Please provide the Gradio Space URL.';
                return;
            }

            mergeButton.disabled = true;
            videoContainer.style.display = 'none';
            statusDiv.textContent = 'Step 1/3: Connecting to Gradio client...';

            try {
                console.log(`Connecting to: ${spaceUrl}`);
                const client = await Client.connect(spaceUrl);
                console.log("Connection successful.");
                statusDiv.textContent = 'Step 2/3: Uploading files and processing... This can take some time.';

                const result = await client.predict("/add_audio", [
                    videoFile,
                    audioFile,
                ]);

                console.log("Received API result:", result);
                statusDiv.textContent = 'Step 3/3: Handling response...';

                const outputVideoData = result.data[0];
                const statusMessage = result.data[1];

                if (outputVideoData && outputVideoData.url) {
                    videoResult.src = outputVideoData.url;
                    videoContainer.style.display = 'block';
                    statusDiv.textContent = `Success! ${statusMessage}`;
                } else {
                    throw new Error(statusMessage || "The server returned a null result without an error message.");
                }

            } catch (error) {
                console.error('A critical error occurred:', error);
                
                let errorMessage = error.message;
                if (errorMessage.includes("Could not connect")) {
                    errorMessage = "Could not connect to the Gradio Space. Please check the URL and ensure the Space is running.";
                }
                statusDiv.textContent = `Error: ${errorMessage}`;
            } finally {
                mergeButton.disabled = false;
                console.log("Process finished.");
            }
        });
    </script>

</body>
</html>
